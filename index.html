<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Industrial Fault Logger Pro</title>
<style>
body{
  font-family: Arial, sans-serif;
  background:#1e1e1e;
  color:#f2f2f2;
  margin:15px;
}
h1,h2{ text-align:center; }
input, select, textarea, button{
  width:100%;
  padding:10px;
  margin:6px 0;
  border-radius:6px;
  border:none;
  font-size:14px;
}
input, select, textarea{
  background:#2c2c2c;
  color:white;
}
button{
  background:#ff9500;
  color:black;
  font-weight:bold;
}
button:hover{ opacity:0.9; }

.card{
  background:#2c2c2c;
  padding:10px;
  margin:10px 0;
  border-radius:8px;
}
img{
  max-width:100%;
  border-radius:6px;
  margin-top:5px;
}
.stats{
  display:flex;
  justify-content:space-between;
  margin-bottom:15px;
}
.stat-box{
  background:#2c2c2c;
  padding:10px;
  border-radius:6px;
  width:48%;
  text-align:center;
}
.small-btn{
  width:auto;
  padding:5px 10px;
  font-size:12px;
  margin-right:5px;
}
</style>
</head>
<body>

<h1>Fault Logger Pro</h1>

<div class="stats">
  <div class="stat-box">
    <b>Total Faults</b>
    <div id="totalCount">0</div>
  </div>
  <div class="stat-box">
    <b>Most Common Machine</b>
    <div id="commonMachine">-</div>
  </div>
</div>

<h2>Add Fault</h2>

<select id="machine">
  <option value="">Select Machine</option>
  <option>Excavator 1</option>
  <option>Crusher A</option>
  <option>Conveyor Line 3</option>
  <option>Generator Unit 2</option>
</select>

<input id="subdivision" placeholder="Subdivision">
<input id="fault" placeholder="Fault Description">
<textarea id="action" placeholder="Action Taken"></textarea>
<input id="stores" placeholder="Stores Location / Parts">
<input id="manual" placeholder="Manual Chapter / Page">
<input type="date" id="date">
<input type="file" id="photo" accept="image/*">
<button onclick="addFault()">Save Fault</button>

<h2>Search & Filters</h2>
<input id="search" placeholder="Search all fields" oninput="render()">
<select id="filterMachine" onchange="render()">
  <option value="">Filter by Machine</option>
  <option>Excavator 1</option>
  <option>Crusher A</option>
  <option>Conveyor Line 3</option>
  <option>Generator Unit 2</option>
</select>
<input type="date" id="filterDate" onchange="render()">

<button onclick="exportCSV()">Export CSV</button>
<button onclick="emailReport()">Email Report</button>
<button onclick="clearAll()">Clear All Data</button>

<h2>Fault Logs</h2>
<div id="logs"></div>

<script>
let faults = JSON.parse(localStorage.getItem("faults_pro")) || [];

function saveData(){
  localStorage.setItem("faults_pro", JSON.stringify(faults));
}

function addFault(){
  const file = document.getElementById("photo").files[0];
  const reader = new FileReader();

  reader.onload = function(){
    const newFault = {
      id: Date.now(),
      machine: machine.value,
      subdivision: subdivision.value,
      fault: fault.value,
      action: action.value,
      stores: stores.value,
      manual: manual.value,
      date: date.value,
      photo: reader.result || ""
    };
    faults.push(newFault);
    saveData();
    document.querySelectorAll("input, textarea").forEach(el => el.value="");
    machine.value="";
    render();
  };

  if(file){
    reader.readAsDataURL(file);
  } else {
    reader.onload();
  }
}

function deleteFault(id){
  faults = faults.filter(f=>f.id!==id);
  saveData();
  render();
}

function render(){
  const searchText = search.value.toLowerCase();
  const filterMachineVal = filterMachine.value;
  const filterDateVal = filterDate.value;

  const filtered = faults.filter(f =>
    (f.machine + f.subdivision + f.fault + f.action + f.stores + f.manual)
      .toLowerCase().includes(searchText)
    &&
    (filterMachineVal==="" || f.machine===filterMachineVal)
    &&
    (filterDateVal==="" || f.date===filterDateVal)
  );

  logs.innerHTML="";
  filtered.slice().reverse().forEach(f=>{
    logs.innerHTML+=`
      <div class="card">
        <b>Machine:</b> ${f.machine}<br>
        <b>Date:</b> ${f.date}<br>
        <b>Fault:</b> ${f.fault}<br>
        <b>Action:</b> ${f.action}<br>
        <b>Stores:</b> ${f.stores}<br>
        <b>Manual:</b> ${f.manual}<br>
        ${f.photo ? `<img src="${f.photo}">`:""}
        <br>
        <button class="small-btn" onclick="deleteFault(${f.id})">Delete</button>
      </div>
    `;
  });

  updateStats();
}

function updateStats(){
  totalCount.innerText = faults.length;

  const machineCounts = {};
  faults.forEach(f=>{
    if(f.machine){
      machineCounts[f.machine] = (machineCounts[f.machine]||0)+1;
    }
  });

  let mostCommon="-";
  let max=0;
  for(let m in machineCounts){
    if(machineCounts[m]>max){
      max=machineCounts[m];
      mostCommon=m;
    }
  }
  commonMachine.innerText = mostCommon;
}

function exportCSV(){
  let csv="Machine,Subdivision,Date,Fault,Action,Stores,Manual\n";
  faults.forEach(f=>{
    csv+=`"${f.machine}","${f.subdivision}","${f.date}","${f.fault}","${f.action}","${f.stores}","${f.manual}"\n`;
  });
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="fault_logs.csv";
  a.click();
}

function emailReport(){
  let body="Fault Report:\n\n";
  faults.forEach(f=>{
    body+=`Machine: ${f.machine}\nDate: ${f.date}\nFault: ${f.fault}\nAction: ${f.action}\n\n`;
  });
  window.location.href=`mailto:?subject=Fault Report&body=${encodeURIComponent(body)}`;
}

function clearAll(){
  if(confirm("Delete ALL fault logs?")){
    faults=[];
    saveData();
    render();
  }
}

render();
</script>

</body>
</html>

